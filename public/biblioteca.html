<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Biblioteca - Rumbo Seguro</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ESTILOS EXCLUSIVOS PARA EL VIDEO */
        .video-wrapper {
            margin-top: 15px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background: #000;
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* Relaci칩n de aspecto 16:9 (Youtube) */
            height: 0;
            overflow: hidden;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        
        /* Pesta침as del formulario */
        .tabs { display: flex; gap: 10px; margin-bottom: 1rem; }
        .tab-btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #f9fafb; cursor: pointer; border-radius: 5px; text-align: center; }
        .tab-btn.active { background: #005A9C; color: white; border-color: #005A9C; }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
             <h3>游닄 Biblioteca</h3>
             <a href="dashboard.html" class="btn btn-outline">Volver</a>
        </div>
    </header>

    <main class="container" style="display: grid; grid-template-columns: 1fr; gap: 2rem; margin-top: 2rem;">
        
        <section>
            <div id="recursos-container">Cargando...</div>
        </section>

        <aside id="upload-aside" class="card" style="display: none;">
            <h3>Subir Recurso</h3>
            
            <div class="tabs">
                <div class="tab-btn active" onclick="switchTab('file')">Archivo</div>
                <div class="tab-btn" onclick="switchTab('video')">Video YouTube</div>
            </div>

            <form id="upload-form">
                <input type="hidden" id="upload-type" value="file">
                
                <div style="margin-bottom:10px;">
                    <input type="text" id="nombre_archivo" class="form-input" required placeholder="T칤tulo">
                </div>
                <div style="margin-bottom:10px;">
                    <select id="curso" class="form-input">
                        <option value="C치lculo">C치lculo</option>
                        <option value="F칤sica">F칤sica</option>
                        <option value="Qu칤mica">Qu칤mica</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div style="margin-bottom:10px;">
                    <select id="tipo" class="form-input">
                        <option value="Examen">Examen</option>
                        <option value="Clase">Clase Grabada</option>
                    </select>
                </div>

                <div id="input-file-group" style="margin-bottom:10px;">
                    <input type="file" id="archivo" class="form-input">
                </div>

                <div id="input-youtube-group" style="margin-bottom:10px; display:none;">
                    <input type="url" id="youtube_url" class="form-input" placeholder="Pega el link de YouTube aqu칤">
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%;">Publicar</button>
            </form>
        </aside>
    </main>

    <script>
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        
        document.addEventListener('DOMContentLoaded', () => {
            if (usuario && usuario.rol !== 'estudiante') {
                document.getElementById('upload-aside').style.display = 'block';
                document.querySelector('main').style.gridTemplateColumns = "2fr 1fr";
            }
            cargarRecursos();
            setupForm();
        });

        function switchTab(type) {
            document.getElementById('upload-type').value = type;
            // Cambiar visual de pesta침as (simple)
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (type === 'file') {
                document.getElementById('input-file-group').style.display = 'block';
                document.getElementById('input-youtube-group').style.display = 'none';
                document.getElementById('archivo').required = true;
                document.getElementById('youtube_url').required = false;
            } else {
                document.getElementById('input-file-group').style.display = 'none';
                document.getElementById('input-youtube-group').style.display = 'block';
                document.getElementById('archivo').required = false;
                document.getElementById('youtube_url').required = true;
            }
        }

        // --- L칍GICA DE VIDEO ---
        function getYoutubeId(url) {
            if (!url) return null;
            // Regex poderoso para detectar ID de cualquier link de youtube
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        async function cargarRecursos() {
            const container = document.getElementById('recursos-container');
            const res = await fetch('/api/biblioteca');
            const recursos = await res.json();
            
            container.innerHTML = '';
            recursos.reverse().forEach(recurso => {
                const item = document.createElement('div');
                item.className = 'card'; // Usamos clase card existente
                item.style.marginBottom = "20px";

                // Detectar si es video
                const videoId = getYoutubeId(recurso.url_descarga);
                let contenido = '';

                if (videoId) {
                    // ES VIDEO: MOSTRAR REPRODUCTOR
                    contenido = `
                        <div class="video-wrapper">
                            <div class="video-container">
                                <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
                            </div>
                        </div>
                    `;
                } else {
                    // ES ARCHIVO: MOSTRAR BOT칍N
                    contenido = `
                        <a href="${recurso.url_descarga}" target="_blank" class="btn btn-success" style="margin-top:10px;">
                            Descargar Archivo
                        </a>
                    `;
                }

                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <h4>${recurso.nombre_archivo} <small style="color:gray;">(${recurso.curso})</small></h4>
                        <span style="font-size:0.8rem; background:#eee; padding:5px; border-radius:5px;">${recurso.tipo}</span>
                    </div>
                    ${contenido}
                    <div style="margin-top:10px; font-size:0.8rem; color:gray;">Subido por: ${recurso.usuarios?.nombres}</div>
                `;
                container.appendChild(item);
            });
        }

        function setupForm() {
            document.getElementById('upload-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData();
                const type = document.getElementById('upload-type').value;

                formData.append('nombre_archivo', document.getElementById('nombre_archivo').value);
                formData.append('curso', document.getElementById('curso').value);
                formData.append('tipo', document.getElementById('tipo').value);
                formData.append('uploader_id', usuario.id);

                if (type === 'file') {
                    formData.append('archivo', document.getElementById('archivo').files[0]);
                } else {
                    formData.append('youtube_url', document.getElementById('youtube_url').value);
                }

                await fetch('/api/recursos', { method: 'POST', body: formData });
                alert('Publicado!');
                cargarRecursos();
                document.getElementById('upload-form').reset();
            });
        }
    </script>
</body>
</html>
