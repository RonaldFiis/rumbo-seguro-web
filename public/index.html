<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Ponderado - 2do Ciclo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Ajustes espec√≠ficos para la calculadora */
        body { background: #f0f2f5; font-family: 'Inter', sans-serif; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; }
        .form-group label { font-weight: 600; color: #374151; flex: 1; }
        .form-group input { width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 1.1rem; }
        .weight-badge { font-size: 0.75rem; background: #e5e7eb; padding: 2px 6px; border-radius: 4px; color: #666; margin-left: 5px; }
        
        .result-box { background: #005A9C; color: white; text-align: center; padding: 1.5rem; border-radius: 10px; margin-top: 2rem; display: none; }
        .result-number { font-size: 3rem; font-weight: 800; line-height: 1; }

        .ranking-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .ranking-table th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; color: #888; font-size: 0.9rem; }
        .ranking-table td { padding: 12px 10px; border-bottom: 1px solid #f3f3f3; font-weight: 500; }
        .rank-num { font-weight: 800; color: #005A9C; width: 30px; display: inline-block; }
        .top-3 { color: #d97706; } /* Dorado para el top */

        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header class="app-header" style="background: white; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center;">
        <h1 style="color: #005A9C; font-size: 1.5rem; margin: 0;"><i class="fas fa-calculator"></i> Ponderado 2do Ciclo</h1>
    </header>

    <div class="main-grid">
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; border-bottom: 2px solid #f3f3f3; padding-bottom: 10px;">Ingresa tus Notas</h2>
            <form id="calc-form">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:5px; font-weight:bold;">Tu Nombre / Apodo:</label>
                    <input type="text" id="nombre" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;" placeholder="Ej. El Cachimbo">
                </div>

                <div class="form-group"><label>C√°lculo Integral <span class="weight-badge">x5</span></label> <input type="number" step="0.1" min="0" max="20" id="n1" required></div>
                <div class="form-group"><label>√Ålgebra Lineal <span class="weight-badge">x4</span></label> <input type="number" step="0.1" min="0" max="20" id="n2" required></div>
                <div class="form-group"><label>Algoritmia <span class="weight-badge">x3</span></label> <input type="number" step="0.1" min="0" max="20" id="n3" required></div>
                <div class="form-group"><label>√âtica <span class="weight-badge">x2</span></label> <input type="number" step="0.1" min="0" max="20" id="n4" required></div>
                <div class="form-group"><label>TCS <span class="weight-badge">x3</span></label> <input type="number" step="0.1" min="0" max="20" id="n5" required></div>
                <div class="form-group"><label>Psicolog√≠a <span class="weight-badge">x3</span></label> <input type="number" step="0.1" min="0" max="20" id="n6" required></div>
                <div class="form-group"><label>Biolog√≠a <span class="weight-badge">x2</span></label> <input type="number" step="0.1" min="0" max="20" id="n7" required></div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 10px; background: #005A9C; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Calcula y entra al Ranking üöÄ
                </button>
            </form>

            <div id="resultado" class="result-box">
                <div>Tu Ponderado es:</div>
                <div class="result-number" id="valor-ponderado">00.00</div>
            </div>
        </div>

        <div class="card">
            <h2 style="color: #d97706; margin-bottom: 1.5rem;"><i class="fas fa-trophy"></i> Ranking en Vivo</h2>
            <div style="overflow-y: auto; max-height: 500px;">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th width="50">#</th>
                            <th>Estudiante</th>
                            <th style="text-align: right;">Ponderado</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <tr><td colspan="3" class="text-center">Cargando posiciones...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';

        // 1. CARGAR RANKING AL INICIO
        document.addEventListener('DOMContentLoaded', cargarRanking);

        // 2. MANEJAR EL FORMULARIO
        document.getElementById('calc-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.textContent = "Calculando...";
            btn.disabled = true;

            const datos = {
                nombre: document.getElementById('nombre').value,
                n1: document.getElementById('n1').value,
                n2: document.getElementById('n2').value,
                n3: document.getElementById('n3').value,
                n4: document.getElementById('n4').value,
                n5: document.getElementById('n5').value,
                n6: document.getElementById('n6').value,
                n7: document.getElementById('n7').value
            };

            try {
                const res = await fetch(API_URL + '/calcular', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                const data = await res.json();

                if (res.ok) {
                    // Mostrar resultado personal
                    document.getElementById('valor-ponderado').textContent = data.ponderado;
                    document.getElementById('resultado').style.display = 'block';
                    
                    // Actualizar tabla
                    cargarRanking();
                    
                    // Resetear bot√≥n
                    btn.textContent = "¬°Calculado!";
                    setTimeout(() => btn.textContent = "Calcular de nuevo", 2000);
                    btn.disabled = false;
                }
            } catch (error) {
                alert("Error al conectar con el servidor");
                btn.disabled = false;
            }
        });

        // 3. FUNCI√ìN PARA ACTUALIZAR TABLA
        async function cargarRanking() {
            try {
                const res = await fetch(API_URL + '/ranking');
                const ranking = await res.json();
                const tbody = document.getElementById('ranking-body');
                
                tbody.innerHTML = '';
                
                ranking.forEach((item, index) => {
                    const pos = index + 1;
                    const esTop = pos <= 3 ? 'top-3' : '';
                    const icono = pos === 1 ? 'üëë' : (pos === 2 ? 'ü•à' : (pos === 3 ? 'ü•â' : pos));
                    
                    const row = `
                        <tr>
                            <td><span class="rank-num ${esTop}">${icono}</span></td>
                            <td>${item.nombre}</td>
                            <td style="text-align: right; font-weight: bold; color: #005A9C;">${item.ponderado.toFixed(2)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (e) {
                console.error("Error cargando ranking");
            }
        }
    </script>
</body>
</html>
