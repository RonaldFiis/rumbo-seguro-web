<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Ponderado - Con Retiros</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; display: flex; justify-content: center; padding: 20px; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1100px; width: 100%; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #2c3e50; margin-top: 0; }
        
        /* Estilos del Formulario */
        .form-row { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; }
        .course-label { flex: 2; font-weight: 600; color: #34495e; font-size: 0.95rem; }
        .badge { background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px; }
        
        input[type="number"] { width: 70px; padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        input[type="number"]:disabled { background: #f3f4f6; color: #aaa; border-color: #eee; }
        
        /* Checkbox de Retiro */
        .retiro-check { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #e74c3c; cursor: pointer; }
        .retiro-check input { cursor: pointer; }

        button { width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 15px; transition: 0.2s; }
        button:hover { background: #2563eb; transform: translateY(-1px); }

        /* Resultado */
        #resultado-box { text-align: center; margin-top: 25px; padding: 15px; background: #eff6ff; border-radius: 8px; display: none; }
        .big-score { font-size: 3rem; font-weight: 800; color: #2563eb; line-height: 1; }
        .credits-info { font-size: 0.9rem; color: #6b7280; margin-top: 5px; }

        /* Tabla */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px 8px; border-bottom: 2px solid #eee; color: #888; font-size: 0.9rem; }
        td { padding: 12px 8px; border-bottom: 1px solid #f9f9f9; font-weight: 500; }
        .rank-num { font-weight: 800; color: #3b82f6; }

        @media(max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>üìä Ingreso de Notas</h2>
        <form id="form-notas">
            <div style="margin-bottom: 20px;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Estudiante:</label>
                <input type="text" id="nombre" required placeholder="Tu Nombre o Apodo" style="width: 100%; padding: 10px; border:1px solid #ccc; border-radius:6px;">
            </div>

            <div class="form-row">
                <div class="course-label">C√°lculo Integral <span class="badge">x5</span></div>
                <input type="number" id="n1" step="0.1" min="0" max="20" required placeholder="0-20">
                <label class="retiro-check"><input type="checkbox" onchange="toggleRetiro('n1')"> Retiro</label>
            </div>
            <div class="form-row">
                <div class="course-label">√Ålgebra Lineal <span class="badge">x4</span></div>
                <input type="number" id="n2" step="0.1" min="0" max="20" required placeholder="0-20">
                <label class="retiro-check"><input type="checkbox" onchange="toggleRetiro('n2')"> Retiro</label>
            </div>
            <div class="form-row">
                <div class="course-label">Algoritmia <span class="badge">x3</span></div>
                <input type="number" id="n3" step="0.1" min="0" max="20" required placeholder="0-20">
                <label class="retiro-check"><input type="checkbox" onchange="toggleRetiro('n3')"> Retiro</label>
            </div>
            <div class="form-row">
                <div class="course-label">√âtica <span class="badge">x2</span></div>
                <input type="number" id="n4" step="0.1" min="0" max="20" required placeholder="0-20">
                <label class="retiro-check"><input type="checkbox" onchange="toggleRetiro('n4')"> Retiro</label>
            </div>
            <div class="form-row">
                <div class="course-label">TCS <span class="badge">x3</span></div>
                <input type="number" id="n5" step="0.1" min="0" max="20" required placeholder="0-20">
                <label class="retiro-check"><input type="checkbox" onchange="toggleRetiro('n5')"> Retiro</label>
            </div>
            <div class="form-row">
                <div class="course-label">Psicolog√≠a <span class="badge">x3</span></div>
                <input type="number" id="n6" step="0.1" min="0" max="20" required placeholder="0-20">
                <label class="retiro-check"><input type="checkbox" onchange="toggleRetiro('n6')"> Retiro</label>
            </div>
            <div class="form-row">
                <div class="course-label">Biolog√≠a <span class="badge">x2</span></div>
                <input type="number" id="n7" step="0.1" min="0" max="20" required placeholder="0-20">
                <label class="retiro-check"><input type="checkbox" onchange="toggleRetiro('n7')"> Retiro</label>
            </div>

            <button type="submit">Calcular y Rankear üöÄ</button>
        </form>

        <div id="resultado-box">
            <div>Tu Ponderado Oficial:</div>
            <div class="big-score" id="score-val">00.00</div>
            <div class="credits-info" id="credits-val">Calculado sobre 22 cr√©ditos</div>
        </div>
    </div>

    <div class="card">
        <h2 style="color: #d97706;">üèÜ Ranking Top 100</h2>
        <div style="overflow-y: auto; max-height: 600px;">
            <table>
                <thead>
                    <tr>
                        <th width="40">#</th>
                        <th>Estudiante</th>
                        <th style="text-align: right;">Ponderado</th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    <tr><td colspan="3" style="text-align:center">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API = window.location.origin + '/api';

    // 1. L√ìGICA VISUAL DE RETIRO
    window.toggleRetiro = (id) => {
        const input = document.getElementById(id);
        const checkbox = document.querySelector(`input[onchange="toggleRetiro('${id}')"]`);
        
        if (checkbox.checked) {
            input.disabled = true;
            input.value = ""; // Limpia visualmente
            input.placeholder = "Retiro";
            input.style.backgroundColor = "#fceceb"; // Rojo suave
        } else {
            input.disabled = false;
            input.placeholder = "0-20";
            input.style.backgroundColor = "white";
        }
    };

    // 2. ENVIAR FORMULARIO
    document.getElementById('form-notas').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.textContent;
        btn.textContent = "Calculando...";
        btn.disabled = true;

        // Funci√≥n auxiliar para obtener valor: si est√° disabled, manda -1
        const getVal = (id) => {
            const input = document.getElementById(id);
            return input.disabled ? -1 : input.value;
        };

        const data = {
            nombre: document.getElementById('nombre').value,
            n1: getVal('n1'),
            n2: getVal('n2'),
            n3: getVal('n3'),
            n4: getVal('n4'),
            n5: getVal('n5'),
            n6: getVal('n6'),
            n7: getVal('n7')
        };

        try {
            const res = await fetch(API + '/calcular', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await res.json();
            
            if (result.success) {
                document.getElementById('score-val').textContent = result.ponderado;
                document.getElementById('credits-val').textContent = `Calculado sobre ${result.creditos} cr√©ditos efectivos`;
                document.getElementById('resultado-box').style.display = 'block';
                await cargarRanking(); 
            } else {
                alert('Error al guardar datos.');
            }
        } catch (err) {
            console.error(err);
            alert('Error de conexi√≥n.');
        }
        
        btn.disabled = false;
        btn.textContent = originalText;
    });

    // 3. CARGAR RANKING
    async function cargarRanking() {
        try {
            const res = await fetch(API + '/ranking');
            const lista = await res.json();
            const tbody = document.getElementById('tabla-body');
            tbody.innerHTML = '';

            lista.forEach((item, index) => {
                const puesto = index + 1;
                let icono = `<span class="rank-num" style="color:#666">${puesto}</span>`;
                if(puesto === 1) icono = 'ü•á';
                if(puesto === 2) icono = 'ü•à';
                if(puesto === 3) icono = 'ü•â';

                tbody.innerHTML += `
                    <tr>
                        <td style="font-size:1.2rem; text-align:center;">${icono}</td>
                        <td>${item.nombre}</td>
                        <td style="text-align: right; font-weight: bold; color: #2563eb;">${parseFloat(item.ponderado).toFixed(2)}</td>
                    </tr>
                `;
            });
        } catch (e) {
            console.error(e);
        }
    }

    cargarRanking();
</script>

</body>
</html>
