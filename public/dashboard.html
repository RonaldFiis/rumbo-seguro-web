<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Aula - Rumbo Seguro</title>
    <link rel="icon" href="images/logo.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header class="app-header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="index.html" class="nav-logo">
                        <img src="images/logo.svg" alt="Logo">
                    </a>
                    <span style="font-size: 1.2rem; font-weight: 700; color: var(--dark); letter-spacing: -0.5px;">RUMBO SEGURO</span>
                </div>
                
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="header-icons" style="display: flex; gap: 15px;">
                        <div style="position: relative; cursor: pointer;">
                            <i class="far fa-bell" style="font-size: 1.2rem; color: var(--gray);"></i>
                            <span class="notification-dot" style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%;"></span>
                        </div>
                        <div style="position: relative; cursor: pointer;">
                            <i class="far fa-comment-alt" style="font-size: 1.2rem; color: var(--gray);"></i>
                        </div>
                    </div>

                    <div style="width: 1px; height: 25px; background: #e5e7eb;"></div>

                    <div class="user-menu" style="display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleMenu()">
                        <div class="text-right" style="text-align: right; line-height: 1.2;">
                            <div style="font-weight: 600; font-size: 0.9rem;" id="nombre-usuario">Cargando...</div>
                            <div style="font-size: 0.75rem; color: var(--gray); text-transform: uppercase;" id="rol-usuario">Estudiante</div>
                        </div>
                        <div class="tutor-avatar" style="width: 40px; height: 40px; font-size: 1.2rem; margin: 0;">
                            <i class="fas fa-user"></i>
                        </div>
                        <i class="fas fa-chevron-down" style="font-size: 0.8rem; color: var(--gray);"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container" id="panel-contenido" style="margin-bottom: 4rem; padding-top: 2rem;">
        <div class="text-center" style="padding: 50px; color: var(--gray);">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Cargando tu espacio personal...</p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario) return window.location.href = 'login.html';

            document.getElementById('nombre-usuario').textContent = usuario.nombres.split(' ')[0];
            document.getElementById('rol-usuario').textContent = usuario.rol;

            const panel = document.getElementById('panel-contenido');

            if (usuario.rol === 'estudiante') {
                await renderEstudiante(panel, usuario);
            } else if (usuario.rol === 'tutor') {
                await renderTutor(panel, usuario);
            } else {
                await renderPsicologo(panel);
            }
        });

        function toggleMenu() {
            const confirmLogout = confirm("¬øDeseas cerrar sesi√≥n?");
            if (confirmLogout) {
                localStorage.removeItem('usuario');
                window.location.href = 'index.html';
            }
        }

        async function renderEstudiante(panel, usuario) {
            let riesgoHTML = '<span class="risk-badge bg-Pendiente">Pendiente</span>';
            let msgRiesgo = 'Realiza tu evaluaci√≥n inicial.';
            
            try {
                const res = await fetch(`/api/riesgo/${usuario.id}`);
                if (res.ok) {
                    const r = await res.json();
                    const colorMap = { 'Bajo': 'bg-Bajo', 'Medio': 'bg-Medio', 'Alto': 'bg-Alto', 'Cr√≠tico': 'bg-Cr√≠tico' };
                    riesgoHTML = `<span class="risk-badge ${colorMap[r.nivel]}">${r.nivel.toUpperCase()}</span>`;
                    msgRiesgo = `Evaluado: ${new Date(r.fecha_evaluacion).toLocaleDateString()}`;
                }
            } catch(e) {}

            panel.innerHTML = `
                <div class="welcome-banner" style="margin-bottom: 2.5rem;">
                    <h2 style="font-size: 1.8rem;">üëã ¬°Hola, ${usuario.nombres.split(' ')[0]}!</h2>
                    <p style="opacity: 0.9;">Aqu√≠ tienes tus herramientas de apoyo acad√©mico.</p>
                </div>

                <h3 style="margin-bottom: 1.5rem; color: var(--primary); font-size: 1.4rem;">Mis Herramientas</h3>

                <div class="tools-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem;">
                    
                    <div class="tool-card">
                        <div class="card-header-bg bg-riesgo">
                            <span class="card-tag">Estado Acad√©mico</span>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">Mi Diagn√≥stico</h3>
                            <div style="margin-bottom: 10px;">${riesgoHTML}</div>
                            <p class="card-desc">${msgRiesgo}</p>
                            <div style="margin-top: auto;">
                                <a href="evaluacion.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                                    <i class="fas fa-clipboard-list"></i> Realizar Test
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="tool-card">
                        <div class="card-header-bg bg-tutor">
                            <span class="card-tag">Acompa√±amiento</span>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">Solicitar Tutor√≠a</h3>
                            <p class="card-desc">Refuerza tus cursos con compa√±eros expertos de ciclos superiores.</p>
                            <div style="margin-top: auto;">
                                <a href="tutorias.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                                    <i class="fas fa-users"></i> Ver Tutores
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="tool-card">
                        <div class="card-header-bg bg-biblio">
                            <span class="card-tag">Recursos</span>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">Biblioteca Digital</h3>
                            <p class="card-desc">Accede a ex√°menes pasados, solucionarios y videos de clases.</p>
                            <div style="margin-top: auto;">
                                <a href="biblioteca.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                                    <i class="fas fa-book"></i> Ir a Biblioteca
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="tool-card">
                        <div class="card-header-bg bg-ia">
                            <span class="card-tag">Inteligencia Artificial</span>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">Asistente Virtual</h3>
                            <p class="card-desc">Resuelve tus dudas acad√©micas y administrativas al instante, 24/7.</p>
                            <div style="margin-top: auto;">
                                <a href="asistente.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                                    <i class="fas fa-robot"></i> Hablar con IA
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            `;
        }

        async function renderTutor(panel, usuario) {
            let conteo = 0;
            try {
                const res = await fetch(`/api/solicitudes-tutor/${usuario.id}`);
                const data = await res.json();
                conteo = data.count;
            } catch(e) {}

            panel.innerHTML = `
                <div class="welcome-banner">
                    <h2>üë®‚Äçüè´ Panel de Docente Tutor</h2>
                    <p>Gestiona tus tutor√≠as y apoya a la comunidad.</p>
                </div>

                <div class="tools-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem;">
                    <div class="tool-card">
                        <div class="card-header-bg bg-tutor"><span class="card-tag">Perfil</span></div>
                        <div class="card-body">
                            <h3>Mis Especialidades</h3>
                            <p class="card-desc">Define qu√© cursos puedes ense√±ar.</p>
                            <a href="perfil.html" class="btn btn-outline" style="margin-top: auto;">Editar Perfil</a>
                        </div>
                    </div>
                    
                    <div class="tool-card">
                        <div class="card-header-bg bg-riesgo"><span class="card-tag">Gesti√≥n</span></div>
                        <div class="card-body">
                            <h3>Solicitudes ${conteo > 0 ? `<span class="notification-badge">${conteo}</span>` : ''}</h3>
                            <p class="card-desc">Estudiantes que necesitan tu ayuda.</p>
                            <a href="solicitudes.html" class="btn btn-primary" style="margin-top: auto;">Ver Solicitudes</a>
                        </div>
                    </div>

                    <div class="tool-card">
                        <div class="card-header-bg bg-biblio"><span class="card-tag">Aportes</span></div>
                        <div class="card-body">
                            <h3>Subir Recurso</h3>
                            <p class="card-desc">Comparte material educativo.</p>
                            <a href="biblioteca.html" class="btn btn-secondary" style="margin-top: auto;">Ir a Biblioteca</a>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderPsicologo(panel) {
             panel.innerHTML = `
                <div class="welcome-banner" style="background: linear-gradient(135deg, #be123c, #881337);">
                    <h2>üß† Panel de Psicolog√≠a</h2>
                    <p>Seguimiento de casos cr√≠ticos.</p>
                </div>
                <div id="casos-lista">
                    <div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando casos...</div>
                </div>
            `;
            // Carga de casos (usando la l√≥gica que ya tienes en tu server.js)
            try {
                const res = await fetch('/api/casos-riesgo');
                const casos = await res.json();
                const container = document.getElementById('casos-lista');
                if(casos.length===0) container.innerHTML = '<div class="card">No hay casos cr√≠ticos.</div>';
                else {
                    container.innerHTML = '<div class="dashboard-grid" style="grid-template-columns:1fr;">' + casos.map(c => `
                        <div class="card" style="border-left: 5px solid #ef4444; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h3>${c.estudiante?.nombres || 'Estudiante'}</h3>
                                <p>${c.estudiante?.email || ''}</p>
                                <span class="risk-badge bg-Cr√≠tico">${c.nivel} (${c.puntaje})</span>
                            </div>
                            <a href="mailto:${c.estudiante?.email}" class="btn btn-outline">Contactar</a>
                        </div>
                    `).join('') + '</div>';
                }
            } catch(e) { document.getElementById('casos-lista').innerHTML = 'Error.'; }
        }
    </script>
</body>
</html>
