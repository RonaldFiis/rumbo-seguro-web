<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel del Estudiante - Rumbo Seguro</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header class="uni-header">
        <div class="container">
            <div style="display: flex; align-items: center; gap: 15px;">
                <a href="index.html" class="nav-logo">
                    <img src="images/logo.svg" alt="Logo">
                </a>
                <span style="font-size: 1.2rem; font-weight: 700; color: var(--dark);">RUMBO SEGURO</span>
            </div>

            <div class="uni-user-menu">
                <div style="position: relative; cursor: pointer;">
                    <i class="far fa-bell" style="font-size: 1.2rem; color: var(--gray);"></i>
                    <span style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 10px;">2</span>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <div class="text-right" style="text-align: right;">
                        <div style="font-weight: 600; font-size: 0.9rem;" id="nombre-usuario">Cargando...</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">Estudiante</div>
                    </div>
                    <div class="uni-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 0.8rem; color: var(--gray);"></i>
                </div>
                
                <button id="btn-logout" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem;" title="Cerrar Sesión">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container" id="panel-contenido">
        <div style="margin-bottom: 2rem;">
            <h1 style="font-size: 2rem;">¡Hola, <span id="nombre-saludo">Estudiante</span>!</h1>
            <p style="color: var(--gray);">Bienvenido a tu panel de Rumbo Seguro. Aquí tienes tus herramientas de apoyo.</p>
        </div>

        <div class="tools-grid">
            
            <div class="tool-card">
                <div class="card-header-bg bg-riesgo">
                    <span class="card-tag">Diagnóstico</span>
                </div>
                <div class="card-body">
                    <h3 class="card-title">Mi Estado Académico</h3>
                    <div id="estado-riesgo-container">
                        <p style="font-size: 0.9rem; color: var(--gray);">Cargando estado...</p>
                    </div>
                    <div style="margin-top: auto; padding-top: 1rem;">
                        <a href="evaluacion.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                            <i class="fas fa-clipboard-check"></i> Realizar Test IMRA
                        </a>
                    </div>
                </div>
            </div>

            <div class="tool-card">
                <div class="card-header-bg bg-tutor">
                    <span class="card-tag">Acompañamiento</span>
                </div>
                <div class="card-body">
                    <h3 class="card-title">Solicitar Tutoría</h3>
                    <p class="card-desc">Conecta con compañeros de ciclos superiores para reforzar tus cursos.</p>
                    <div style="margin-top: auto;">
                        <a href="tutorias.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                            <i class="fas fa-chalkboard-teacher"></i> Ver Tutores
                        </a>
                    </div>
                </div>
            </div>

            <div class="tool-card">
                <div class="card-header-bg bg-biblio">
                    <span class="card-tag">Recursos</span>
                </div>
                <div class="card-body">
                    <h3 class="card-title">Biblioteca Digital</h3>
                    <p class="card-desc">Accede a exámenes pasados, prácticas y solucionarios compartidos.</p>
                    <div style="margin-top: auto;">
                        <a href="biblioteca.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                            <i class="fas fa-book"></i> Ir a Biblioteca
                        </a>
                    </div>
                </div>
            </div>

        </div>

        <div class="ai-footer-banner">
            <div style="flex: 1;">
                <h3 style="margin: 0 0 5px 0; font-size: 1.5rem;">¿Tienes dudas académicas?</h3>
                <p style="margin: 0; opacity: 0.9;">Nuestro asistente virtual está disponible 24/7 para ayudarte.</p>
            </div>
            <div>
                <a href="asistente.html" class="btn" style="background: white; color: var(--primary); font-weight: 700; padding: 12px 30px;">
                    <i class="fas fa-robot"></i> Preguntar a la IA
                </a>
            </div>
        </div>

        <div style="height: 50px;"></div> </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario) return window.location.href = 'login.html';

            const primerNombre = usuario.nombres.split(' ')[0];
            document.getElementById('nombre-usuario').textContent = usuario.nombres;
            document.getElementById('nombre-saludo').textContent = primerNombre;

            document.getElementById('btn-logout').addEventListener('click', () => {
                localStorage.removeItem('usuario');
                window.location.href = 'index.html';
            });

            // Lógica específica para estudiante (Cargar Riesgo)
            if (usuario.rol === 'estudiante') {
                cargarEstadoRiesgo(usuario.id);
            } else {
                // Si es tutor/psicólogo, podrías redirigir o mostrar otro panel
                // Por ahora, dejamos que vean este diseño limpio
            }
        });

        async function cargarEstadoRiesgo(userId) {
            const container = document.getElementById('estado-riesgo-container');
            try {
                const res = await fetch(`/api/riesgo/${userId}`);
                if (res.ok) {
                    const r = await res.json();
                    const colorMap = {
                        'Bajo': 'bg-Bajo', 'Medio': 'bg-Medio', 
                        'Alto': 'bg-Alto', 'Crítico': 'bg-Crítico'
                    };
                    container.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            <span class="risk-badge ${colorMap[r.nivel]}">${r.nivel.toUpperCase()}</span>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--gray);">
                            Última evaluación: ${new Date(r.fecha_evaluacion).toLocaleDateString()}
                        </p>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            <span class="risk-badge bg-Pendiente">PENDIENTE</span>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--gray);">
                            Aún no has realizado tu evaluación inicial.
                        </p>
                    `;
                }
            } catch (e) {
                container.innerHTML = '<p style="font-size: 0.8rem; color: red;">Error al cargar estado.</p>';
            }
        }
    </script>
</body>
</html>
