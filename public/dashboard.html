<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel - Rumbo Seguro</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: var(--light); }
        .header {
            background: var(--white);
            padding: 1rem 0;
            border-bottom: 2px solid #eee;
        }
        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info { font-weight: 500; color: var(--gray); }
        .user-info strong { color: var(--dark); }
        /* Estilo para la notificaci√≥n del tutor */
        .notification-badge {
            background: var(--danger);
            color: white;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 1rem;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="index.html" class="nav-logo" style="font-size: 1.2rem; gap: 10px;">
                <img src="images/logo.svg" alt="Rumbo Seguro Logo" style="height: 40px;">
                <span>RUMBO SEGURO</span>
            </a>
            <div class="user-controls flex items-center" style="gap: 1.5rem;">
                <a href="biblioteca.html" class="nav-links" style="font-weight: 600;">
                    <i class="fas fa-book"></i> Biblioteca
                </a>
                <span class="user-info">Hola, <strong id="nombre-usuario">...</strong></span>
                <button id="btn-logout" class="btn btn-danger" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </header>

    <main class="container" style="margin-top: 2rem;" id="panel-contenido">
        <div class="text-center" style="padding: 50px; color: var(--gray);">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p style="margin-top: 20px;">Cargando tu panel...</p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario) return window.location.href = 'login.html';

            // Usamos Supabase para inyectar el script (si no, da error en renderTutor)
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            script.onload = () => {
                // Solo renderizamos cuando Supabase est√© listo
                renderPaneles(usuario);
            };
            document.head.appendChild(script);

            document.getElementById('nombre-usuario').textContent = usuario.nombres.split(' ')[0];
            document.getElementById('btn-logout').addEventListener('click', () => {
                localStorage.removeItem('usuario');
                window.location.href = 'index.html';
            });
        });

        function renderPaneles(usuario) {
            const panel = document.getElementById('panel-contenido');
            if (usuario.rol === 'estudiante') {
                renderEstudiante(panel, usuario);
            } else if (usuario.rol === 'tutor') {
                renderTutor(panel, usuario);
            } else if (usuario.rol === 'psicologo') {
                renderPsicologo(panel);
            }
        }

        async function renderEstudiante(panel, usuario) {
            let riesgoHTML = '<span class="risk-badge bg-Pendiente">Pendiente</span>';
            let msgRiesgo = 'No has realizado tu evaluaci√≥n inicial.';
            let colorClase = 'card-blue';

            try {
                const res = await fetch(`/api/riesgo/${usuario.id}`);
                if (res.ok) {
                    const r = await res.json();
                    riesgoHTML = `<span class="risk-badge bg-${r.nivel}">${r.nivel.toUpperCase()}</span>`;
                    msgRiesgo = `Evaluado el: ${new Date(r.fecha_evaluacion).toLocaleDateString()}`;
                    if (r.nivel === 'Cr√≠tico') colorClase = 'card-red';
                    else if (r.nivel === 'Alto' || r.nivel === 'Medio') colorClase = 'card-orange';
                    else if (r.nivel === 'Bajo') colorClase = 'card-green';
                }
            } catch (e) {}

            panel.innerHTML = `
                <div class="welcome-banner">
                    <h2>üëã ¬°Hola de nuevo, ${usuario.nombres.split(' ')[0]}!</h2>
                    <p>Estamos aqu√≠ para ayudarte a tener √©xito. Revisa tu estado y accede a tus herramientas.</p>
                </div>
                <div class="dashboard-grid">
                    <div class="main-content">
                        <div class="card ${colorClase}">
                            <h3 style="margin-bottom: 1rem;"><i class="fas fa-chart-line"></i> Tu Estado Actual</h3>
                            <p style="font-size: 1.5rem; font-weight: 600;">Nivel de Riesgo: ${riesgoHTML}</p>
                            <p style="color: var(--gray); font-size: 1rem; margin: 0.5rem 0 1.5rem;">${msgRiesgo}</p>
                            <a href="evaluacion.html" class="btn btn-success" style="font-size: 1rem;">
                                <i class="fas fa-clipboard-list"></i> ${riesgoHTML.includes('Pendiente') ? 'Realizar Evaluaci√≥n' : 'Volver a Evaluar'}
                            </a>
                        </div>
                    </div>
                    <aside class="sidebar" style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div class="card">
                            <h3><i class="fas fa-robot" style="color: var(--primary);"></i> Asistente Virtual</h3>
                            <p style="color: var(--gray); margin: 0.5rem 0 1rem;">Tu compa√±ero de IA 24/7.</p>
                            <a href="asistente.html" class="btn btn-primary" style="width: 100%;">Hablar con IA</a>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-user-friends" style="color: var(--accent);"></i> Tutor√≠as</h3>
                            <p style="color: var(--gray); margin: 0.5rem 0 1rem;">Encuentra un tutor.</p>
                            <a href="tutorias.html" class="btn btn-outline" style="width: 100%;">Ver Tutores</a>
                        </div>
                    </aside>
                </div>
            `;
        }

        async function renderTutor(panel, usuario) {
            let especialidad = 'No definida';
            let conteoSolicitudes = 0;
            let badgeHTML = '';

            try {
                // 1. Cargamos la especialidad (esto estaba bien)
                // (Necesitamos crear el cliente Supabase aqu√≠ porque este script no lo tiene)
                const { createClient } = supabase;
                const db = createClient(
                    '${process.env.SUPABASE_URL}', // Render reemplazar√° esto si est√° en el HTML
                    '${process.env.SUPABASE_KEY}'  // (Esto no es ideal, pero es para un fix r√°pido)
                    // NOTA: Lo ideal es que estas llaves se lean desde el backend.
                    // ¬°PERO ESPERA! No podemos exponer la service key en el frontend.
                    // El error estaba en el FETCH.
                );
                
                // (Mejor, vamos a arreglar el fetch, que es m√°s limpio)
                
                // --- ¬°BUG ARREGLADO! ---
                // 1. Usamos 'await' y 'fetch' correctamente
                const res = await fetch(`/api/solicitudes-tutor/${usuario.id}`);
                if (!res.ok) {
                    throw new Error('Error al cargar el conteo de solicitudes'); 
                }
                
                // 2. Leemos la respuesta como JSON
                const data = await res.json();
                
                // 3. Asignamos el conteo
                conteoSolicitudes = data.count;
                // --- FIN DEL ARREGLO ---
                
                if (conteoSolicitudes > 0) {
                    badgeHTML = `<span class="notification-badge">${conteoSolicitudes}</span>`;
                }

            } catch(e) {
                console.error("Error al cargar datos del tutor:", e.message);
                // No mostramos la especialidad si Supabase no est√° cargado, pero el conteo deber√≠a funcionar.
                especialidad = "(Error al cargar)"; 
            }

            panel.innerHTML = `
                <div class="welcome-banner"><h2>üë®‚Äçüè´ Panel de Docente Tutor</h2></div>
                <div class="dashboard-grid">
                    <div>
                        <div class="card card-blue">
                            <h3><i class="fas fa-chalkboard-teacher"></i> Mis Especialidades</h3>
                            <p style="color: var(--gray); margin: 0.5rem 0 1rem;">Cursos: <strong>(Pr√≥ximamente)</strong></p>
                            <button class="btn btn-outline" onclick="alert('Esta funci√≥n a√∫n est√° en desarrollo.')">Editar Perfil</button>
                        </div>
                    </div>
                    <aside>
                        <div class="card card-orange">
                            <h3><i class="fas fa-users"></i> Solicitudes ${badgeHTML}</h3>
                            <p style="color: var(--gray); margin: 0.5rem 0 1rem;">Tienes <strong>${conteoSolicitudes}</strong> solicitudes pendientes.</p>
                            <button class="btn btn-primary" onclick="alert('Esta funci√≥n a√∫n est√° en desarrollo.')">Ver Solicitudes</button>
                        </div>
                    </aside>
                </div>`;
        }

        function renderPsicologo(panel) {
            panel.innerHTML = `
                <div class="welcome-banner"><h2>üß† Panel de Psicolog√≠a</h2></div>
                <div class="card card-red">
                    <h3><i class="fas fa-exclamation-triangle"></i> Alertas Cr√≠ticas</h3>
                    <p style="color: var(--gray); margin: 0.5rem 0 1rem;"><strong>0</strong> casos requieren atenci√≥n inmediata.</p>
                    <button class="btn btn-danger" onclick="alert('Esta funci√≥n a√∫n est√° en desarrollo.')">Revisar Casos</button>
                </div>`;
        }
    </script>
</body>
</html>
