<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel del Estudiante - Rumbo Seguro</title>
    <link rel="icon" href="images/logo.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header class="app-header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="index.html" class="nav-logo">
                        <img src="images/logo.svg" alt="Logo">
                    </a>
                    <span style="font-size: 1.2rem; font-weight: 700; color: var(--dark);">RUMBO SEGURO</span>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="text-right" style="text-align: right;">
                        <div style="font-weight: 600; font-size: 0.9rem;" id="nombre-usuario">Cargando...</div>
                        <div style="font-size: 0.8rem; color: var(--gray);" id="rol-usuario">Estudiante</div>
                    </div>
                    <button id="btn-logout" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container" id="panel-contenido" style="margin-bottom: 4rem;">
        <div class="text-center" style="padding: 50px; color: var(--gray);">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Cargando tu panel...</p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario) return window.location.href = 'login.html';

            document.getElementById('nombre-usuario').textContent = usuario.nombres.split(' ')[0];
            document.getElementById('rol-usuario').textContent = usuario.rol.charAt(0).toUpperCase() + usuario.rol.slice(1);

            document.getElementById('btn-logout').addEventListener('click', () => {
                localStorage.removeItem('usuario');
                window.location.href = 'index.html';
            });

            const panel = document.getElementById('panel-contenido');

            // L√ìGICA PARA ESTUDIANTE
            if (usuario.rol === 'estudiante') {
                await renderEstudiante(panel, usuario);
            } 
            // L√ìGICA PARA TUTOR
            else if (usuario.rol === 'tutor') {
                await renderTutor(panel, usuario);
            }
            // L√ìGICA PARA PSIC√ìLOGO
            else {
                await renderPsicologo(panel);
            }
        });

        async function renderEstudiante(panel, usuario) {
            // Obtener Estado de Riesgo
            let riesgoHTML = '<span class="risk-badge bg-Pendiente">Pendiente</span>';
            let msgRiesgo = 'No has realizado tu evaluaci√≥n inicial.';
            
            try {
                const res = await fetch(`/api/riesgo/${usuario.id}`);
                if (res.ok) {
                    const r = await res.json();
                    const colorMap = { 'Bajo': 'bg-Bajo', 'Medio': 'bg-Medio', 'Alto': 'bg-Alto', 'Cr√≠tico': 'bg-Cr√≠tico' };
                    riesgoHTML = `<span class="risk-badge ${colorMap[r.nivel]}">${r.nivel.toUpperCase()}</span>`;
                    msgRiesgo = `Evaluado el: ${new Date(r.fecha_evaluacion).toLocaleDateString()}`;
                }
            } catch(e) {}

            // HTML del Dashboard Estudiante (ESTILO UNIVIRTUAL)
            panel.innerHTML = `
                <div class="welcome-banner">
                    <h2>üëã ¬°Hola, ${usuario.nombres.split(' ')[0]}!</h2>
                    <p>Bienvenido a tu panel. Aqu√≠ tienes tus herramientas de apoyo.</p>
                </div>

                <div class="tools-grid">
                    <div class="tool-card">
                        <div class="card-header-bg bg-riesgo">
                            <span class="card-tag">Diagn√≥stico</span>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">Estado Acad√©mico</h3>
                            <div style="margin-bottom: 10px;">${riesgoHTML}</div>
                            <p class="card-desc">${msgRiesgo}</p>
                            <div style="margin-top: auto;">
                                <a href="evaluacion.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                                    <i class="fas fa-clipboard-check"></i> Realizar Test IMRA
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="tool-card">
                        <div class="card-header-bg bg-tutor">
                            <span class="card-tag">Acompa√±amiento</span>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">Solicitar Tutor√≠a</h3>
                            <p class="card-desc">Refuerza tus cursos con compa√±eros expertos.</p>
                            <div style="margin-top: auto;">
                                <a href="tutorias.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                                    <i class="fas fa-chalkboard-teacher"></i> Ver Tutores
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="tool-card">
                        <div class="card-header-bg bg-biblio">
                            <span class="card-tag">Recursos</span>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">Biblioteca Digital</h3>
                            <p class="card-desc">Accede a ex√°menes pasados y videos de clases.</p>
                            <div style="margin-top: auto;">
                                <a href="biblioteca.html" class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;">
                                    <i class="fas fa-book"></i> Ir a Biblioteca
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-footer-banner">
                    <div>
                        <h3 style="margin: 0; color: white;">¬øTienes dudas acad√©micas?</h3>
                        <p style="margin: 0; opacity: 0.9; color: white;">Nuestro asistente virtual est√° disponible 24/7.</p>
                    </div>
                    <a href="asistente.html" class="btn" style="background: white; color: var(--primary); font-weight: 700;">
                        <i class="fas fa-robot"></i> Preguntar a la IA
                    </a>
                </div>
            `;
        }

        async function renderTutor(panel, usuario) {
            // Obtener conteo de solicitudes
            let conteo = 0;
            let badgeHTML = '';
            try {
                const res = await fetch(`/api/solicitudes-tutor/${usuario.id}`);
                const data = await res.json();
                conteo = data.count;
                if (conteo > 0) badgeHTML = `<span class="notification-badge">${conteo}</span>`;
            } catch(e) {}

            panel.innerHTML = `
                <div class="welcome-banner">
                    <h2>üë®‚Äçüè´ Panel de Docente Tutor</h2>
                    <p>Gestiona tus clases y ayuda a tus compa√±eros.</p>
                </div>

                <div class="dashboard-grid">
                    <div class="tool-card">
                         <div class="card-body">
                            <h3>Mis Especialidades</h3>
                            <p class="card-desc">Gestiona los cursos que ense√±as.</p>
                            <a href="perfil.html" class="btn btn-outline">Editar Perfil</a>
                         </div>
                    </div>
                    <div class="tool-card">
                         <div class="card-body">
                            <h3>Solicitudes ${badgeHTML}</h3>
                            <p class="card-desc">Revisa qui√©n necesita tu ayuda.</p>
                            <a href="solicitudes.html" class="btn btn-primary">Ver Solicitudes</a>
                         </div>
                    </div>
                     <div class="tool-card">
                         <div class="card-body">
                            <h3>Aportar Recurso</h3>
                            <p class="card-desc">Sube material a la biblioteca.</p>
                            <a href="biblioteca.html" class="btn btn-secondary">Ir a Biblioteca</a>
                         </div>
                    </div>
                </div>
            `;
        }

        async function renderPsicologo(panel) {
            panel.innerHTML = `
                <div class="welcome-banner" style="background: linear-gradient(135deg, #be123c, #881337);">
                    <h2>üß† Panel de Psicolog√≠a</h2>
                    <p>Monitoreo de estudiantes en riesgo acad√©mico.</p>
                </div>
                <h3 style="margin-bottom: 1.5rem;">Casos Detectados (Prioridad Alta)</h3>
                <div id="casos-lista" class="dashboard-grid" style="grid-template-columns: 1fr;">
                    <div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Cargando datos...</div>
                </div>
            `;

            try {
                const res = await fetch('/api/casos-riesgo');
                const casos = await res.json();
                const container = document.getElementById('casos-lista');

                if (casos.length === 0) {
                    container.innerHTML = '<div class="card"><p>No hay casos de riesgo registrados actualmente.</p></div>';
                    return;
                }

                container.innerHTML = '';
                casos.forEach(caso => {
                    const nombre = caso.estudiante ? caso.estudiante.nombres : "Estudiante (ID: " + caso.estudiante_id + ")";
                    const email = caso.estudiante ? caso.estudiante.email : "#";
                    const badgeClass = caso.nivel === 'Cr√≠tico' ? 'bg-Cr√≠tico' : 'bg-Alto';
                    const borderClass = caso.nivel === 'Cr√≠tico' ? 'border-left: 5px solid #ef4444;' : 'border-left: 5px solid #f59e0b;';

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style = `${borderClass} display: flex; justify-content: space-between; align-items: center;`;
                    
                    card.innerHTML = `
                        <div>
                            <h3 style="margin: 0 0 5px 0; font-size: 1.1rem;">${nombre}</h3>
                            <p style="margin: 0; color: var(--gray); font-size: 0.9rem;">${email}</p>
                            <div style="margin-top: 10px;">
                                <span class="risk-badge ${badgeClass}">${caso.nivel} (${caso.puntaje}/10)</span>
                                <small style="color: #999; margin-left: 10px;">${new Date(caso.fecha_evaluacion).toLocaleDateString()}</small>
                            </div>
                        </div>
                        <div>
                            <a href="mailto:${email}" class="btn btn-outline btn-sm">
                                <i class="fas fa-envelope"></i> Contactar
                            </a>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error(error);
                document.getElementById('casos-lista').innerHTML = '<p style="color: red;">Error al cargar los casos. Verifica la conexi√≥n.</p>';
            }
        }
    </script>
</body>
</html>
