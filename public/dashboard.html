<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Espacio - Rumbo Seguro</title>
    <link rel="icon" href="images/logo.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Ajustes locales para igualar tu captura */
        body { background-color: #fff; } /* Fondo blanco limpio como en tu foto */
        .dashboard-container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        
        /* Tarjeta de Estado (La Azul de tu foto) */
        .status-card {
            background: #e3f2fd; /* Azul claro exacto */
            border-left: 6px solid var(--primary);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2.5rem;
        }
        .status-title { display: flex; align-items: center; gap: 10px; color: var(--dark); font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; }
        
        /* Grid de Herramientas (Para que no se vea vac√≠o) */
        .tools-section h3 { margin-bottom: 1.5rem; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .tools-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .tool-box {
            background: white; border: 1px solid #eee;
            border-radius: 12px; padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .tool-box:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.08); border-color: var(--primary); }
        .tool-icon { font-size: 2rem; margin-bottom: 1rem; color: var(--primary); }
        .tool-title { font-weight: 700; margin-bottom: 0.5rem; font-size: 1.1rem; }
        .tool-desc { font-size: 0.9rem; color: var(--gray); margin-bottom: 1.5rem; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <a href="index.html" class="nav-logo">
                    <img src="images/logo.svg" alt="Logo">
                    <span>RUMBO SEGURO</span>
                </a>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="user-info">Hola, <strong id="nombre-usuario">...</strong></span>
                    <button id="btn-logout" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-container" id="panel-contenido">
        <div class="text-center" style="padding: 50px; color: var(--gray);">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Cargando tu espacio...</p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario) return window.location.href = 'login.html';

            document.getElementById('nombre-usuario').textContent = usuario.nombres.split(' ')[0];

            document.getElementById('btn-logout').addEventListener('click', () => {
                localStorage.removeItem('usuario');
                window.location.href = 'index.html';
            });

            if (usuario.rol === 'estudiante') {
                renderEstudiante(panel, usuario);
            } else if (usuario.rol === 'tutor') {
                renderTutor(panel, usuario);
            } else {
                // Psic√≥logo u otros
                document.getElementById('panel-contenido').innerHTML = `<h2>Bienvenido, ${usuario.rol}</h2>`;
            }
        });

        const panel = document.getElementById('panel-contenido');

        async function renderEstudiante(panel, usuario) {
            let riesgoHTML = '<span class="risk-badge bg-Pendiente">Pendiente de evaluaci√≥n</span>';
            let msgRiesgo = 'A√∫n no has realizado tu autoevaluaci√≥n inicial.';
            let btnTexto = 'Realizar Autoevaluaci√≥n IMRA';

            try {
                const res = await fetch(`/api/riesgo/${usuario.id}`);
                if (res.ok) {
                    const r = await res.json();
                    const colorMap = { 'Bajo': 'bg-Bajo', 'Medio': 'bg-Medio', 'Alto': 'bg-Alto', 'Cr√≠tico': 'bg-Cr√≠tico' };
                    riesgoHTML = `<span class="risk-badge ${colorMap[r.nivel]}">${r.nivel.toUpperCase()}</span>`;
                    msgRiesgo = `√öltima evaluaci√≥n: ${new Date(r.fecha_evaluacion).toLocaleDateString()}`;
                    btnTexto = 'Volver a Evaluar';
                }
            } catch (e) {}

            panel.innerHTML = `
                <h1 style="margin-bottom: 2rem;">üëã Bienvenido a tu espacio personal</h1>
                
                <div class="status-card">
                    <div class="status-title"><i class="fas fa-chart-bar"></i> Tu Estado Actual</div>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">
                        <strong>Nivel de Riesgo:</strong> ${riesgoHTML}
                    </p>
                    <p style="color: var(--gray); margin-bottom: 1.5rem;">${msgRiesgo}</p>
                    <a href="evaluacion.html" class="btn btn-success">
                        <i class="fas fa-clipboard-check"></i> ${btnTexto}
                    </a>
                </div>

                <div class="tools-section">
                    <h3><i class="fas fa-tools"></i> Tus Herramientas</h3>
                    <div class="tools-row">
                        
                        <div class="tool-box">
                            <div>
                                <div class="tool-icon"><i class="fas fa-robot"></i></div>
                                <h4 class="tool-title">Asistente Virtual</h4>
                                <p class="tool-desc">¬øTienes dudas sobre alg√∫n curso o tr√°mite? Tu asistente est√° listo 24/7.</p>
                            </div>
                            <a href="asistente.html" class="btn btn-primary" style="width: 100%;">Hablar con IA</a>
                        </div>

                        <div class="tool-box">
                            <div>
                                <div class="tool-icon" style="color: var(--accent);"><i class="fas fa-chalkboard-teacher"></i></div>
                                <h4 class="tool-title">Solicitar Tutor√≠a</h4>
                                <p class="tool-desc">Conecta con compa√±eros de ciclos superiores para reforzar tus cursos.</p>
                            </div>
                            <a href="tutorias.html" class="btn btn-outline" style="width: 100%;">Ver Tutores</a>
                        </div>

                        <div class="tool-box">
                            <div>
                                <div class="tool-icon" style="color: var(--secondary);"><i class="fas fa-book"></i></div>
                                <h4 class="tool-title">Biblioteca Digital</h4>
                                <p class="tool-desc">Accede a ex√°menes pasados, pr√°cticas y solucionarios.</p>
                            </div>
                            <a href="biblioteca.html" class="btn btn-secondary" style="width: 100%;">Ir a Biblioteca</a>
                        </div>

                    </div>
                </div>
            `;
        }

        async function renderTutor(panel, usuario) {
            // Reutilizamos la l√≥gica del tutor que ya funcionaba (conteo y perfil)
            let especialidad = 'No definida';
            let conteoSolicitudes = 0;
            let badgeHTML = '';

            try {
                const userRes = await fetch(`/api/usuario/${usuario.id}`);
                const userData = await userRes.json();
                if (userData && userData.especialidad) especialidad = userData.especialidad;
                
                const countRes = await fetch(`/api/solicitudes-tutor/${usuario.id}`);
                const data = await countRes.json();
                conteoSolicitudes = data.count;
                if (conteoSolicitudes > 0) badgeHTML = `<span class="notification-badge">${conteoSolicitudes}</span>`;
            } catch(e) {}

            panel.innerHTML = `
                <h1 style="margin-bottom: 2rem;">üë®‚Äçüè´ Panel de Docente Tutor</h1>
                <div class="status-card" style="border-left-color: var(--accent); background: #fff5f5;">
                    <div class="status-title" style="color: var(--accent);"><i class="fas fa-chalkboard"></i> Mis Especialidades</div>
                    <p style="margin-bottom: 1rem; font-size: 1.1rem;">${especialidad}</p>
                    <a href="perfil.html" class="btn btn-outline">Editar Perfil</a>
                </div>

                <div class="tools-row">
                    <div class="tool-box">
                        <div>
                            <div class="tool-icon" style="color: var(--accent);"><i class="fas fa-users"></i></div>
                            <h4 class="tool-title">Solicitudes ${badgeHTML}</h4>
                            <p class="tool-desc">Tienes <strong>${conteoSolicitudes}</strong> solicitudes pendientes.</p>
                        </div>
                        <a href="solicitudes.html" class="btn btn-primary" style="width: 100%;">Ver Solicitudes</a>
                    </div>
                    
                    <div class="tool-box">
                        <div>
                            <div class="tool-icon" style="color: var(--secondary);"><i class="fas fa-book"></i></div>
                            <h4 class="tool-title">Aportar a la Biblioteca</h4>
                            <p class="tool-desc">Sube ex√°menes o material para los estudiantes.</p>
                        </div>
                        <a href="biblioteca.html" class="btn btn-secondary" style="width: 100%;">Ir a Biblioteca</a>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
